$(function(){function t(){var t=$(this).attr("id"),e=$(this).closest(".list_item").find(".cont"),i=$(this).closest(".params");p(i.find(".map_content:visible"));var n=i.find(".list_item").find(".cont");if(e.is(":visible"))t=$(this).data("id"),n.hide(_);else{(n.length>1?n.not(e):n).hide(_,function(){e.show(_)})}return window.location.hash=t,!1}function e(t,e){var i=e||0;t.each(function(){$(this).find("input, textarea, select").each(function(){var t=$(this).closest("form[data-param]").data("param")+"["+i+"]"+$(this).data("name");$(this).attr("name",t),void 0!==$(this).data("item")&&$(this).data("item",i)}),$(this).find(".num").html(i+1);var t=$(this).find(".head .left");t.attr("id",t.data("id")+"_"+i),i++})}function n(t,i,n){if(!confirm("Удалить строку?"))return!1;var a=$(t).closest(".control").find(i);$(t).closest(n).remove(),e(a.find(n))}function a(t,e){var i=e||0,n=t.closest("[data-param]").data("param");0===t.find(".img").length?t.find("input[type=file]").prop("required",!0):t.find(".img").each(function(){$(this).find("input, textarea, select").each(function(){var t=void 0!==$(this).data("item")?"["+$(this).data("item")+"]":"",e=n+t+$(this).data("field")+"["+i+"]"+$(this).data("file");$(this).attr("name",e)}),i++})}function o(t){if($(t).closest(".text_list").find(".text_list_item").length>1)$(t).closest(".text_list_item").remove();else{var e=$(t).closest(".text_list_item");e.find("input").val(""),e.find("textarea").val(""),e.find("input[type=hidden]").prop("required")&&e.find("input[type=file]").prop("required",!0),e.find("input[type=hidden]").remove(),e.find(".ftitle").remove()}}function l(t){var e=$(t).closest(".text_list"),i=e.find(".text_list_item").eq(0).clone(!0);i.find("input").val(""),i.find("textarea").val(""),i.find("input[type=hidden]").prop("required")&&i.find("input[type=file]").prop("required",!0),i.find("input[type=hidden]").remove(),i.find("input[type=file]").length&&i.find(".move").remove(),i.find(".ftitle").remove(),e.find(".text_list_items").append(i)}function s(t){var e=$(t).closest(".table_list"),n=e.find("tbody tr");n.length>1?$(t).closest("tr").remove():$(t).closest("tr").find("input").val(""),n=e.find("tbody tr"),i=0,n.each(function(){$(this).find("input").each(function(){var t=$(this).data("subname");$(this).attr("name",t.replace("%num%",i))}),i++})}function r(t){var e=$(t).closest(".table_list"),i=e.find("tbody tr"),n=i.eq(0).clone(!0),a=n.find("input");a.val(""),a.each(function(){var t=$(this).data("subname");$(this).attr("name",t.replace("%num%",i.length))}),e.find("tbody").append(n)}function c(t){$(".current").each(function(){var e=$(this).attr("href"),i=$(e);i.hasClass("section")?$(".section").not(i).hide(t,function(){i.show(t)}):i.hasClass("group")&&$(".group").not(i).hide(t,function(){i.show(t)})})}function d(t){if(0==t.length)return!1;var e=t.data(),i={};void 0!==e.width&&(i.width=e.width),void 0!==e.height&&(i.height=e.height),void 0!==e.controls&&(i.controls=e.controls),void 0!==e.colors&&(i.colors=e.colors),void 0!==e.fonts&&(i.fonts=e.fonts),void 0!==e.sizes&&(i.sizes=e.sizes),t.cleditor(i)}function f(){var t=k.geometry.getCoordinates();k.properties.set("iconCaption","поиск..."),ymaps.geocode(t).then(function(t){var e=t.geoObjects.get(0);k.properties.set({iconCaption:[e.getLocalities().length?e.getLocalities():e.getAdministrativeAreas(),e.getThoroughfare()||e.getPremise()].filter(Boolean).join(", "),balloonContent:e.getAddressLine()})})}function u(t,e,i){var n=t.find(".map_content");n.show(400,function(){g=new ymaps.Map(n[0],{center:e,zoom:i,controls:["zoomControl","geolocationControl","searchControl","fullscreenControl"]}),k=new ymaps.Placemark(e,{},{preset:"islands#blueDotIconWithCaption",draggable:!0}),g.events.add("click",function(t){var e=t.get("coords");k.geometry.setCoordinates(e),f()}),g.geoObjects.add(k),k.events.add("dragend",function(){f()}),f()}),t.find(".map_manage").show(400),$form=t.closest("form"),$save=$form.find("button[name=cms_save]"),$save.prop("disabled",!0),$(".map_link").hide(400)}function p(t){var e=$(t).closest(".yandex_map");$(".map_link").show(400),e.find(".map_content").html(""),e.find(".map_content").hide(400),e.find(".map_manage").hide(400),$form=e.closest("form"),$save=$form.find("button[name=cms_save]"),$save.prop("disabled",!1)}function m(t){var e=$(t).closest(".yandex_map"),i=e.find(".lat input").val(),n=e.find(".lon input").val(),a=e.find(".zoom input").val()||16,o=[i,n];o[0]&&o[1]?u(e,o,a):ymaps.geolocation.get(0).then(function(t){u(e,t.geoObjects.position,a)})}function h(t){if(!g||!k)return!1;var e=g.getZoom(),i=k.geometry.getCoordinates(),n=$(t).closest(".yandex_map");n.find(".lat input").val(i[0]),n.find(".lon input").val(i[1]),n.find(".zoom input").val(e),p(t)}function v(t){$(t).each(function(){var t=$(this);t.find(".color_input input").colpick({submitText:"Выбрать",onSubmit:function(t,e,i,n,a){$parent=$(n).closest(".colorpicker"),$parent.find(".color_input input").val("#"+e),$parent.find(".color_area").css("background","#"+e),$(n).colpickHide()}}),$(this).find(".color_area").click(function(){t.find(".color_input input").colpickShow()})})}$(".imglist .img_del").on("click",function(t){t.preventDefault();var e=$(this).closest(".imglist");$(this).closest(".img").remove(),a(e)}),$(".imgfield .img_del").on("click",function(t){t.preventDefault();$(this).closest(".imgfield");$(this).closest(".img").remove()}),$("table tfoot .add").on("click",function(t){t.preventDefault();var e=$(this).closest(".control"),i=e.find("table.params tbody"),a=e.data("param"),s=i.find("tr").length,r=e.find("table.dot tr").clone();r.find(".delete").on("click",function(t){t.preventDefault(),n(this,"table.params tbody","tr")}),r.find(".text_list_item_delete").click(function(t){t.preventDefault(),o(this)}),r.find(".text_list_item_add").click(function(t){t.preventDefault(),l(this)}),r.find(".link_ymap").click(function(t){t.preventDefault(),m(this)}),r.find(".link_ymap_save").click(function(t){t.preventDefault(),h(this)}),r.find(".link_ymap_cancel").click(function(t){t.preventDefault(),p(this)}),v(r.find(".colorpicker")),r.find("input, textarea, select").each(function(){var t=a+"["+s+"]"+$(this).data("name");$(this).attr("name",t),$(this).data("require")&&$(this).prop("required",!0)}),r.find(".num").html(s+1),i.append(r),d(i.find(".cledit"))}),$("table tbody .delete").on("click",function(t){t.preventDefault(),n(this,"table.params tbody","tr")}),$(".manage .add").on("click",function(e){e.preventDefault();var i=$(this).closest(".control"),a=i.find("div.params"),s=i.data("param"),r=a.find(".list_item").length,c=i.find("div.dot .list_item").clone(),d=c.find(".head .left");c.find(".delete").on("click",function(t){t.preventDefault(),n(this,"div.params",".list_item")}),c.find(".text_list_item_delete").click(function(t){t.preventDefault(),o(this)}),c.find(".text_list_item_add").click(function(t){t.preventDefault(),l(this)}),c.find(".link_ymap").click(function(t){t.preventDefault(),m(this)}),c.find(".link_ymap_save").click(function(t){t.preventDefault(),h(this)}),c.find(".link_ymap_cancel").click(function(t){t.preventDefault(),p(this)}),v(c.find(".colorpicker")),c.find("input, textarea, select").each(function(){var t=s+"["+r+"]"+$(this).data("name");$(this).is("select")&&console.log(s),$(this).attr("name",t),$(this).data("require")&&$(this).prop("required",!0)}),c.find(".num").html(r+1),d.attr("id",d.data("id")+"_"+r),d.on("click",t),a.append(c),i.find(".params .list_item").last().find(".left").click()}),$(".params .list_item .head .delete").on("click",function(t){t.preventDefault(),n(this,"div.params",".list_item")});var _=400;$(".list_item .cont").not(":eq(0)").hide(),$(".list_item .head .left").on("click",t),$("nav.groups ul li a").click(function(t){t.preventDefault();var e=$(this),i=$("nav.groups ul li a"),n=e.attr("href");i.not(e).removeClass("current"),e.addClass("current"),window.location.hash=n,c(400)}),$("nav.sections ul li a").click(function(t){t.preventDefault();var e=$(this);$("nav.sections ul li a").not(e).removeClass("current"),e.addClass("current");var i=e.attr("href");$(i).find("nav.groups ul li a").eq(0).click()}),function(){for(var t=location.hash;t.indexOf("_")>-1;){var e=$(t);e.length>0&&(e.hasClass("section")?$("nav.sections ul li a[href="+t+"]").addClass("current"):e.hasClass("group")?$("nav.groups ul li a[href="+t+"]").addClass("current"):e.hasClass("left")&&e.click()),t=t.substr(0,t.lastIndexOf("_"))}var i=$(".current").length;if(1===i){var n=$(".current").attr("href");$(n).find("nav.groups ul li a").eq(0).addClass("current")}else 0==i&&($("nav.sections ul li a").eq(0).addClass("current"),$("nav.groups ul li a").eq(0).addClass("current"))}(),c(0),$(".text_list_item_delete").click(function(t){t.preventDefault(),o(this)}),$(".text_list_item_add").click(function(t){t.preventDefault(),l(this)}),$(".table_list_item_delete").click(function(t){t.preventDefault(),s(this)}),$(".table_list_item_add").click(function(t){t.preventDefault(),r(this)}),$(".imglist").sortable({items:".img",placeholder:"empty",cursor:"move",opacity:.5,revert:!0}),$(".text_list_items").sortable({items:".text_list_item",placeholder:"empty",handle:".move",axis:"y",cursor:"move",opacity:.5,revert:!0}),$(".table_list tbody").sortable({items:".table_list_item",placeholder:"empty",handle:".table_list_item_move",axis:"y",cursor:"move",opacity:.5,revert:!0}),$("div.params").sortable({items:".list_item",placeholder:"empty_item",handle:".move_item",axis:"y",cursor:"move",opacity:.5,revert:!0,stop:function(t,i){e($(this).find(".list_item"))}}),$("table.params tbody").sortable({items:".table_item",placeholder:"empty_item",handle:".move_item",axis:"y",cursor:"move",opacity:.5,revert:!0,stop:function(t,i){e($(this).find("tr"))}}),$(".params .cledit, .single_field .cledit").each(function(){d($(this))});var g=!1,k=!1;$(".link_ymap").click(function(t){t.preventDefault(),m(this)}),$(".link_ymap_save").click(function(t){t.preventDefault(),h(this)}),$(".link_ymap_cancel").click(function(t){t.preventDefault(),p(this)}),v($(".colorpicker")),$(".content_hided").show()});